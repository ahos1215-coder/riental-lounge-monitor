name: Blog Request (Draft + Public Facts)

on:
  workflow_dispatch:
    inputs:
      request_id:
        description: "request_id (uuid or yyyymmddhhmmss)"
        required: true
      store_id:
        description: "store slug (e.g., shibuya)"
        required: true
      target_date:
        description: "YYYY-MM-DD (JST)"
        required: true
      kind:
        description: "tonight / weekly / howto"
        required: true
        default: "tonight"
        type: choice
        options:
          - tonight
          - weekly
          - howto
      angle:
        description: "optional: first-visit / comparison / timing / safety"
        required: false
        default: ""
      tone:
        description: "optional: calm / friendly / serious"
        required: false
        default: "calm"
      notes:
        description: "optional: 禁止表現 / 入れたい一文など"
        required: false
        default: ""
      backend_url:
        description: "backend API base for facts generation"
        required: false
        default: "https://riental-lounge-monitor.onrender.com"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: blog-request-${{ github.event.inputs.request_id }}
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install
        working-directory: frontend
        run: npm ci

      - name: Compute slug/branch
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          ymd="${{ github.event.inputs.target_date }}"
          ymd8="${ymd//-/}"
          slug="${{ github.event.inputs.store_id }}-${{ github.event.inputs.kind }}-${ymd8}"

          rid_raw="${{ github.event.inputs.request_id }}"
          rid="$(echo "$rid_raw" | tr -cd 'A-Za-z0-9._-' | cut -c1-32)"
          if [ -z "$rid" ]; then rid="req"; fi

          branch="bot/blog-${slug}-${rid}"
          echo "slug=${slug}" >> "$GITHUB_OUTPUT"
          echo "branch=${branch}" >> "$GITHUB_OUTPUT"

      - name: Create draft MDX (+ stub facts file)
        working-directory: frontend
        run: |
          set -euo pipefail
          node scripts/new-blog-request.mjs \
            --request_id "${{ github.event.inputs.request_id }}" \
            --store_id "${{ github.event.inputs.store_id }}" \
            --target_date "${{ github.event.inputs.target_date }}" \
            --kind "${{ github.event.inputs.kind }}" \
            --angle "${{ github.event.inputs.angle }}" \
            --tone "${{ github.event.inputs.tone }}" \
            --notes "${{ github.event.inputs.notes }}" \
            --slug "${{ steps.meta.outputs.slug }}"

      - name: Generate public facts (uses /api/range)
        working-directory: frontend
        env:
          BACKEND_URL: ${{ github.event.inputs.backend_url }}
          NEXT_PUBLIC_BASE_URL: https://www.meguribi.jp
        run: |
          set -euo pipefail
          npm run facts:generate
          node scripts/build-public-facts-index.mjs

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.meta.outputs.branch }}
          delete-branch: true
          commit-message: "feat(blog): draft ${{ steps.meta.outputs.slug }} (request ${{ github.event.inputs.request_id }})"
          title: "blog draft: ${{ steps.meta.outputs.slug }}"
          body: |
            Request:
            - request_id: ${{ github.event.inputs.request_id }}
            - store_id: ${{ github.event.inputs.store_id }}
            - target_date: ${{ github.event.inputs.target_date }}
            - kind: ${{ github.event.inputs.kind }}
            - angle: ${{ github.event.inputs.angle }}
            - tone: ${{ github.event.inputs.tone }}

            Notes:
            ${{ github.event.inputs.notes }}
          add-paths: |
            frontend/content/blog/${{ steps.meta.outputs.slug }}.mdx
            frontend/content/facts/public/**