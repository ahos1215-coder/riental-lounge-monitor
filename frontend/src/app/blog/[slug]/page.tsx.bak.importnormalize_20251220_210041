import type { Metadata } from "next";
import Link from "next/link";
import {
  notFound } from "next/navigation";
import { readPublicFacts } from "@/lib/blog/publicFacts";
import { FactsSummaryCard } from "@/components/blog/FactsSummaryCard";
import {
  getPostBySlug,
  formatYmdToSlash,,
  getAllPostMetas
} from "@/lib/blog/content";












function Callout({ children, title }: { children: React.ReactNode; title?: string }) {


  return (


    <div className="rounded-xl border border-white/10 bg-black/30 p-4">


      {title && <div className="text-xs font-bold text-white/80">{title}</div>}


      <div className="mt-2 text-sm leading-7 text-white/75">{children}</div>


    </div>


  );


}





function FactsBox({ facts }: { facts: any }) {


  if (!facts) return null;


  return (


    <div className="rounded-xl border border-white/10 bg-white/5 p-4">


      <div className="text-xs font-bold text-white/80">くわしく（Facts）</div>


      <pre className="mt-2 overflow-auto whitespace-pre-wrap break-words text-xs leading-5 text-white/60">


        {JSON.stringify(facts, null, 2)}


      </pre>


      <div className="mt-2 text-[11px] text-white/40">


        ※ MVPではここは仮表示。将来「数字は最小」「注意点は隔離」のルールでUI整形します。


      </div>


    </div>


  );


}





export async function generateStaticParams() {


  const metas = getAllPostMetas();


  return metas.map((m) => ({ slug: m.slug }));


}





export async function generateMetadata({




}: {


  params: Promise<{ slug: string }>;


}): Promise<Metadata> {


  const { slug } = await params;


  const post = getPostBySlug(slug);


  if (!post) {


    return {


      title: "記事が見つかりません | めぐりび",


      description: "指定された記事は見つかりませんでした。",


    };


  }


  return {


    title: `${post.title} | めぐりびブログ`,


    description: post.description,


  };


}





export default async function BlogPostPage({ params }: { params: Promise<{ slug: string }> }) {


  const { slug } = await params;


  const post = getPostBySlug(slug);


  if (!post) notFound();





  const related = getAllPostMetas()


    .filter((p) => p.slug !== post.slug && p.categoryId === post.categoryId)


    .slice(0, 3);





  const legacyFacts = post.factsId ? getFactsById(post.factsId) : null;
  const factsId =
    (post as any)?.facts_id ??
    (post as any)?.factsId ??
    (post as any)?.frontmatter?.facts_id ??
    (post as any)?.frontmatter?.factsId ??
    (post as any)?.meta?.facts_id ??
    (post as any)?.meta?.factsId ??
    (post as any)?.facts_id_public ??
    null;

  const facts = factsId ? readPublicFacts(String(factsId)) : null;

  return (


    <main className="relative min-h-[calc(100vh-80px)] bg-black text-white">


      <div className="pointer-events-none absolute inset-0">


        <div className="absolute left-1/4 top-[-120px] h-[420px] w-[420px] rounded-full bg-indigo-600/10 blur-3xl" />


        <div className="absolute right-1/4 top-[120px] h-[420px] w-[420px] rounded-full bg-amber-400/10 blur-3xl" />


      </div>





      <div className="relative mx-auto w-full max-w-3xl px-4 pb-16 pt-10">


        <Link href="/blog" className="text-sm text-white/60 hover:text-white">


          ← ブログ一覧に戻る


        </Link>





        <article className="mt-6 overflow-hidden rounded-2xl border border-white/10 bg-white/5">


          <div className="relative aspect-[16/7]">


            <div className={"absolute inset-0 " + post.heroClassName} />


            <div className="absolute inset-0 bg-black/35" />


          </div>





          <div className="p-6 md:p-8">


            <div className="flex flex-wrap items-center gap-3">


              <span


                className={


                  "inline-flex items-center rounded-md px-2 py-0.5 text-xs font-semibold text-white " +


                  post.badgeClassName


                }


              >


                {post.categoryLabel}


              </span>


              <span className="text-xs text-white/40">


                {formatYmdToSlash(post.date)} ・ {post.minutes}分


              </span>


            </div>





            <h1 className="mt-3 text-2xl font-black leading-tight tracking-tight md:text-3xl">


              {post.title}


            </h1>





            <p className="mt-4 text-sm text-white/70 md:text-base">{post.description}</p>





            <div className="mt-8 space-y-4 text-[15px] leading-7 text-white/80">


              <MDXRemote


                source={post.mdx}


                options={{ mdxOptions: { remarkPlugins: [remarkGfm] } }}


                components={{


                  h2: (p: any) => <h2 {...p} className="mt-8 text-lg font-bold text-white" />,


                  h3: (p: any) => <h3 {...p} className="mt-6 text-base font-bold text-white" />,


                  p: (p: any) => <p {...p} className="text-[15px] leading-7 text-white/80" />,


                  ul: (p: any) => <ul {...p} className="list-disc space-y-1 pl-5 text-white/80" />,


                  ol: (p: any) => <ol {...p} className="list-decimal space-y-1 pl-5 text-white/80" />,


                  a: (p: any) => <a {...p} className="underline decoration-white/30 hover:decoration-white/60" />,


                  blockquote: (p: any) => (


                    <blockquote {...p} className="border-l-2 border-white/20 pl-4 text-white/70" />


                  ),




                }}


              />


            </div>





            <div className="mt-8 space-y-3">


              <Callout title="運用メモ（MVP）">


                この記事は GitHub の MDX から表示しています。n8n で下書き→PR作成→あなたが確認してマージ、の流れに最適化します。


              </Callout>


              {facts && <FactsBox facts={facts} />}


            </div>


          </div>


                <FactsSummaryCard facts={facts} />
</article>





        {related.length > 0 && (


          <section className="mt-10">


            <h2 className="text-lg font-bold">関連する記事</h2>


            <div className="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">


              {related.map((p) => (


                <Link


                  key={p.slug}


                  href={`/blog/${p.slug}`}


                  className="rounded-2xl border border-white/10 bg-white/5 p-4 hover:border-white/20"


                >


                  <div className="flex items-center justify-between gap-3">


                    <span


                      className={


                        "inline-flex items-center rounded-md px-2 py-0.5 text-xs font-semibold text-white " +


                        p.badgeClassName


                      }


                    >


                      {p.categoryLabel}


                    </span>


                    <span className="text-xs text-white/40">{formatYmdToSlash(p.date)}</span>


                  </div>


                  <p className="mt-2 text-sm font-bold leading-snug text-white">{p.title}</p>


                  <p className="mt-2 text-xs text-white/60 [display:-webkit-box] [-webkit-line-clamp:2] [-webkit-box-orient:vertical] overflow-hidden">


                    {p.description}


                  </p>


                </Link>


              ))}


            </div>


          </section>


        )}


      </div>


    </main>


  );


}
