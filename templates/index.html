<!doctype html>
<html lang="ja" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ORIENTAL LOUNGE ダッシュボード</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bg:    '#0b0f17',
            panel: '#111827',
            card:  '#0f1623',
            text:  '#e5e7eb',
            sub:   '#9ca3af',
            brand: '#4f46e5',
            men:   '#60a5fa',
            women: '#f59e0b',
            total: '#22d3ee',
          },
          boxShadow: {
            soft: '0 8px 24px rgba(0,0,0,0.35)',
          }
        }
      }
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-bg text-text min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-10 backdrop-blur bg-bg/70 border-b border-white/5">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-brand/20 grid place-items-center ring-1 ring-brand/30">
          <span class="text-brand font-bold">OL</span>
        </div>
        <h1 class="text-lg md:text-xl font-semibold tracking-wide">ORIENTAL LOUNGE</h1>
      </div>
      <div class="ml-auto text-sub text-sm flex items-center gap-3">
        <span id="updatedAt">--:-- 更新</span>
        <button id="refreshBtn" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 transition border border-white/10">
          再読込
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- KPI cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- men -->
      <div class="rounded-2xl bg-card shadow-soft border border-white/5 p-5">
        <div class="text-sub text-xs">現在 男</div>
        <div id="kpiMen" class="mt-2 text-3xl font-bold text-men">--</div>
      </div>
      <!-- women -->
      <div class="rounded-2xl bg-card shadow-soft border border-white/5 p-5">
        <div class="text-sub text-xs">現在 女</div>
        <div id="kpiWomen" class="mt-2 text-3xl font-bold text-women">--</div>
      </div>
      <!-- total -->
      <div class="rounded-2xl bg-card shadow-soft border border-white/5 p-5">
        <div class="text-sub text-xs">現在 合計</div>
        <div id="kpiTotal" class="mt-2 text-3xl font-bold text-total">--</div>
      </div>
      <!-- 今日の取得件数 -->
      <div class="rounded-2xl bg-card shadow-soft border border-white/5 p-5">
        <div class="text-sub text-xs">本日 取得件数</div>
        <div id="kpiCount" class="mt-2 text-3xl font-bold">--</div>
      </div>
    </section>

    <!-- Chart + JSON -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Chart card -->
      <div class="lg:col-span-2 rounded-2xl bg-panel shadow-soft border border-white/5 p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold">本日の推移（10分刻み / 合計・男性・女性）</h2>
          <div class="text-sub text-xs" id="windowInfo"></div>
        </div>
        <div class="mt-4">
          <canvas id="trendChart" height="120"></canvas>
        </div>
        <div class="mt-3 text-sub text-xs">※ `/api/range` を集計して可視化</div>
      </div>

      <!-- JSON + meta -->
      <div class="rounded-2xl bg-panel shadow-soft border border-white/5 p-5 space-y-4">
        <h2 class="text-base font-semibold">最新のJSON</h2>
        <pre id="jsonBox" class="text-xs bg-black/30 p-3 rounded-lg border border-white/5 overflow-x-auto max-h-80"></pre>

        <div class="grid grid-cols-2 gap-3">
          <div class="rounded-xl bg-black/30 p-3 border border-white/5">
            <div class="text-sub text-xs">遅延</div>
            <div id="delayMin" class="mt-1 text-xl font-bold">--分</div>
          </div>
          <div class="rounded-xl bg-black/30 p-3 border border-white/5">
            <div class="text-sub text-xs">欠損枠（10分落ち）</div>
            <div id="missingSlots" class="mt-1 text-xl font-bold">--枠</div>
          </div>
        </div>

        <div class="text-sub text-xs">テスト収集: <code class="text-white/70">/tasks/collect?men=0&amp;women=0</code></div>
      </div>
    </section>

    <!-- Stores (将来拡張用のカード例) -->
    <section class="rounded-2xl bg-panel shadow-soft border border-white/5 p-5">
      <h2 class="text-base font-semibold mb-3">ソース情報</h2>
      <div id="sourceLink" class="text-brand text-sm underline underline-offset-4 break-all"></div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-sub text-xs">
    © 2025 ORIENTAL LOUNGE Monitor
  </footer>

  <script>
    // ========== helpers ==========
    const fmt = (n) => (n ?? '--');
    const toDate = (s) => new Date(s);

    // 10分刻みのラベル作成（実際に存在する行から生成）
    function buildBuckets(rows) {
      // rows: [{time:"HH:MM", ...}]
      const set = new Set();
      for (const r of rows) set.add(r.time);
      const labels = Array.from(set).sort();
      return labels;
    }

    function aggregateSeries(labels, rows, key) {
      const map = new Map(rows.map(r => [r.time, r[key] ?? null]));
      return labels.map(t => map.has(t) ? map.get(t) : null);
    }

    function minutesDiffFromNow(tsIso) {
      if (!tsIso) return null;
      const d = new Date(tsIso);
      const now = new Date();
      const diffMs = now - d;
      return Math.max(0, Math.round(diffMs / 60000));
    }

    function countMissing10m(labels, rows) {
      const set = new Set(rows.map(r => r.time));
      let miss = 0;
      for (const t of labels) if (!set.has(t)) miss++;
      return miss;
    }

    // ========== Chart ==========
    let chart;
    function renderChart(labels, men, women, total) {
      const ctx = document.getElementById('trendChart');
      const data = {
        labels,
        datasets: [
          { label: '合計', data: total, borderWidth: 2, pointRadius: 0, tension: .35, borderColor: '#22d3ee' },
          { label: '男性', data: men,   borderWidth: 2, pointRadius: 0, tension: .35, borderColor: '#60a5fa' },
          { label: '女性', data: women, borderWidth: 2, pointRadius: 0, tension: .35, borderColor: '#f59e0b' },
        ]
      };
      const options = {
        responsive: true,
        scales: {
          x: { grid: { color: 'rgba(255,255,255,.06)' } },
          y: { grid: { color: 'rgba(255,255,255,.06)' }, ticks: { precision: 0, stepSize: 5 } }
        },
        plugins: {
          legend: { labels: { color: '#e5e7eb' } },
          tooltip: { intersect: false, mode: 'index' }
        }
      };
      if (chart) chart.destroy();
      chart = new Chart(ctx, { type: 'line', data, options });
    }

    // ========== fetch & render ==========
    async function load() {
      // current
      const curRes = await fetch('/api/current');
      const cur = await curRes.json();

      // today range
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      const ymd = `${y}-${m}-${d}`;
      const rangeRes = await fetch(`/api/range?from=${ymd}&to=${ymd}&limit=1000`);
      const rangeJson = await rangeRes.json();
      const rows = (rangeJson.rows || []).map(r => ({
        time: r.time, men: r.men ?? null, women: r.women ?? null, total: r.total ?? null, ts: r.ts
      }));

      // KPI
      document.getElementById('kpiMen').textContent    = fmt(cur.men);
      document.getElementById('kpiWomen').textContent  = fmt(cur.women);
      document.getElementById('kpiTotal').textContent  = fmt(cur.total);
      document.getElementById('kpiCount').textContent  = rows.length;

      // 最新JSON表示
      const pretty = JSON.stringify(cur, null, 2);
      document.getElementById('jsonBox').textContent = pretty;

      // 遅延
      const delay = minutesDiffFromNow(cur.ts);
      document.getElementById('delayMin').textContent = (delay == null) ? '--分' : `${delay}分`;

      // 欠損（表示ラベルに対して欠けている時間の数）
      const labels = buildBuckets(rows);
      const missing = countMissing10m(labels, rows);
      document.getElementById('missingSlots').textContent = `${missing}枠`;

      // グラフ
      renderChart(
        labels,
        aggregateSeries(labels, rows, 'men'),
        aggregateSeries(labels, rows, 'women'),
        aggregateSeries(labels, rows, 'total')
      );

      // 補足表示
      document.getElementById('updatedAt').textContent = (cur.time ? `${cur.time} 更新` : '— 更新');
      document.getElementById('windowInfo').textContent = 'データは10分刻みで自動更新';
      document.getElementById('sourceLink').innerHTML = `<a href="${cur.source || '#'}" target="_blank" class="hover:opacity-80">${cur.source || ''}</a>`;
    }

    // 初回 & 自動更新
    load();
    document.getElementById('refreshBtn').addEventListener('click', load);
    // 60秒ごとに自動更新（好みで変更可）
    setInterval(load, 60 * 1000);
  </script>
</body>
</html>
